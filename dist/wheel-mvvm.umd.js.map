{"version":3,"file":"wheel-mvvm.umd.js","sources":["../src/observer/dep.ts","../src/observer/observer.ts","../src/observer/watcher.ts"],"sourcesContent":["import Watcher from './watcher'\n\nlet uid = 0\n\n// \"target\" is the current watcher being evaluated.\n// this is globally unique because there could be only one\n// watcher being evaluated at any time.\n// so it's a static property\n\n\nexport default class Dep {\n  id: number\n  subs: Array<Watcher>\n  static target: Watcher\n\n  constructor () {\n    this.id = uid++\n    this.subs = []\n  }\n\n  addSub (sub: Watcher): void {\n    this.subs.push(sub)\n  }\n\n  removeSub (sub: Watcher): void {\n    let index = this.subs.indexOf(sub)\n    if (index > -1) {\n      this.subs.splice(index, 1)\n    }\n  }\n\n  // Because target is globally unique, so we use Dep class to access target\n  // instead of instance because this should be only one target at any time\n  depend () {\n    if (Dep.target) {\n      Dep.target.addDep(this)\n    }\n  }\n  \n  notify () {\n    // Vue create a copy of original subs to \"stabilize\"\n    // need furthur understanding of this\n    const subs = this.subs.slice()\n    for (let i = 0, l = subs.length; i < l; i++) {\n      subs[i].update()\n    }\n  }\n}\n\nDep.target = null","import Dep from './dep'\n\nexport default class Observer {\n  value: any\n  dep: Dep\n\n  constructor (value: any) {\n    this.value = value\n    this.dep = new Dep()\n\n    this.walk(value)\n  }\n\n  walk (obj: Object) {\n    const keys = Object.keys(obj)\n    for (let i = 0; i < keys.length; i++) {\n      defineReactive(obj, keys[i], obj[keys[i]])\n    }\n  }\n}\n\nfunction defineReactive (obj: Object, key: string, val: any) {\n  const property = Object.getOwnPropertyDescriptor(obj, key)\n  if (property && !property.configurable) {\n    return \n  }\n\n  const getter = property && property.get\n  const setter = property && property.set\n\n  let childOb = observe(val)\n  const dep = new Dep()\n  Object.defineProperty(obj, key, {\n    enumerable: true,\n    configurable: true,\n    get: function reactiveGet () {\n      const value = getter ? getter.call(obj) : val\n      console.log('depends trigger')\n      if (Dep.target) {\n        //TODO: why not obj.dep.depend()\n        dep.depend()\n        if (childOb) {\n          childOb.dep.depend()\n        }\n      }\n      return value\n    },\n    set: function reactiveSet (newVal: any) {\n      const value = getter? getter.call(obj) : val\n      // Vue has one more condition to check for NaN !== NaN\n      // (newVal !== newVal && value !== value)\n      // omit this corner case for now\n      if (newVal === value) {\n        return\n      }\n      if (setter) {\n        setter.call(obj, newVal)\n      } else {\n        val = newVal\n      }\n      childOb = observe(newVal)\n      dep.notify()\n    } \n  })\n}\n\nexport function observe (val: any): Observer | void {\n  if (val === null || typeof val !== 'object') {\n    return\n  }\n\n  let ob: Observer | void\n  ob = new Observer(val)\n  return ob\n}","import Dep from './dep'\n\nexport default class Watcher {\n  vm\n  value: any\n  cb: Function\n  deps: Array<Dep>\n  depIds: Array<number>\n  getter: Function\n  \n  constructor (vm, expOrFn: string | Function, cb: Function) {\n    this.vm = vm\n    this.cb = cb\n    this.deps = []\n    this.depIds = []\n    \n    if (typeof expOrFn === 'function') {\n      this.getter = expOrFn;\n    } else {\n      this.getter = parseGetter(expOrFn);\n    }\n\n\n    this.value = this.get()\n  }\n\n  addDep (dep: Dep) {\n    const id = dep.id\n    if (this.depIds.indexOf(id) === -1) {\n      this.depIds.push(id)\n      this.deps.push(dep)\n      dep.addSub(this)\n    }\n  }\n\n  update () {\n    this.run()\n  }\n\n  run () {\n    const value = this.get()\n    if (value !== this.value || typeof value === 'object') {\n      const oldValue = this.value\n      this.value = value\n      this.cb.call(this.vm, value, oldValue)\n    }\n  } \n  \n  get () {\n    Dep.target = this\n    let value = this.getter.call(this.vm, this.vm)\n    Dep.target = null\n    // there is a cleanupDeps function that compares newDep with dep\n    // it removes any watcher from dep if it's not dependent anymore\n    return value\n  }\n}\n\nfunction parseGetter (exp: string) {\n  if (/[^\\w.$]/.test(exp)) return\n  \n  const exps = exp.split('.')\n  return function (obj) {\n      for (let i = 0, len = exps.length; i < len; i++) {\n          if (!obj) return;\n          obj = obj[exps[i]];\n      }\n      return obj;\n  }\n  \n}"],"names":[],"mappings":"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"}